#!/bin/bash

################################################
#                                              #
#        Por: Ronualdo JSA - PU4RON            #
#                                              #
#                Janauba/MG                    #
#                                              #
################################################

ver=$(awk -F "= " '/Version/ {print $2}' /etc/pistar-release) 
ALDG=`cat /etc/ysfgateway | grep Startup= | cut -f 1`

clear
echo -e "\033[01;37m****************************************\033[00;37m"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m*          \033[01;33mRONUALDO - PU4RON\033[00;37m           *"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m*                 \033[01;33mv2.2    \033[00;37m             *"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m****************************************\033[00;37m"
echo ""
echo ""

if [ `sed -n '/\[Enabled\]/{n;p;}' /etc/dmr2ysf | cut -c 9` != 1 ]; then
        echo ""
        echo "* [DMR2YSF -> "Desligado"] - Antes de continuar ative."
        echo ""
	exit 0
fi

if [ "$ALDG" = "" ]
then
   echo ""
   echo "* ATENCAO!"
   echo "* Nenhum servidor encontrado."
   echo "* Selecione um servidor de conexao e tente novamente."
   echo ""
   exit 0
fi

echo "* Escolha a opcao?" 
echo ""

echo -e " -> [1] \033[01;37m*C4FM PI-STAR*\033[00;37m"
echo ""
echo -e " -> [2] \033[01;37m*PATCH DMRGateway*\033[00;37m"
echo ""
echo -e " -> [3] \033[01;37m*BlueDV PI-STAR*\033[00;37m"
echo ""

read -p "* Digite: " -n 1 -r
case "$REPLY" in 
    1) 
     mount -o remount,rw /

clear
echo -e "\033[01;37m****************************************\033[00;37m"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m*          \033[01;33mRONUALDO - PU4RON\033[00;37m           *"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m*                 \033[01;33mv2.2    \033[00;37m             *"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m****************************************\033[00;37m"
echo ""
echo ""
read -p "*PI-STAR: Continuar? (S/N) " -n 1 -r
case "$REPLY" in 

  s|S ) echo "" ;;
  n|N ) exit 0 ;;
    * ) exit 0 ;;   
esac
echo ""
mount -o remount,rw /

# Check we are root
if [ "$(id -u)" != "0" ];then
	echo "Este script deve ser executado como root" 1>&2
	exit 1
fi

DIR="/home/pi-star/c4fm"
DIRL="/home/pi-star/c4fm/pistar-remote-etc"
DIREtc="/etc"
DIRBin="/usr/local/bin"
DIRSbin="/usr/local/sbin"
DIRSCP="/home/pi-star/c4fm/scp"
DIRSCG="/home/pi-star/c4fm/scg"

Ap="/etc/pistar-remote"
Bp="/usr/local/bin/c4fm"
Bpy="/usr/local/bin/ysf"
Bpo="/usr/local/bin/out"
Cp="/usr/local/bin/YSFGateway"
Dp="/usr/local/bin/MMDVMHost"
Ep="/usr/local/sbin/pistar-remote"

call=$(grep -m 1 'Callsign=' /etc/mmdvmhost | awk -F "=" '/Callsign/ {print $2}')
sudo chattr -i ${DIRBin}/YSFGateway
sudo chattr -i ${DIRSbin}/pistar-remote
sleep 1

echo "* Desativando servicos..."
echo ""
sudo systemctl stop pistar-watchdog.timer      >/dev/null 2>&1 &
sudo systemctl stop pistar-watchdog.service    >/dev/null 2>&1 &
sudo systemctl stop mmdvmhost.timer            >/dev/null 2>&1 &
sudo systemctl stop mmdvmhost.service          >/dev/null 2>&1 &
sudo systemctl stop ysfgateway.service         >/dev/null 2>&1 &
sudo systemctl stop dmr2ysf.service            >/dev/null 2>&1 &
sleep 3
sudo killall MMDVMHost                         >/dev/null 2>&1 &
sleep 2

echo "* Backup..."
echo ""
# sudo cp -R ${Ap} ${Ap}.$(date +%Y%m%d)
sudo cp -R ${Cp} ${Cp}.$(date +%Y%m%d)
sudo cp -R ${Dp} ${Dp}.$(date +%Y%m%d)
sudo cp -R ${Ep} ${Ep}.$(date +%Y%m%d)
sleep 1

if [ -f "$Bp" ]; then
   sudo cp ${Bp} ${Bp}.$(date +%Y%m%d)
 fi

if [ -f "$Bpy" ]; then
   sudo cp ${Bpy} ${Bpy}.$(date +%Y%m%d)
 fi

if [ -f "$Bpo" ]; then
   sudo cp ${Bpo} ${Bpo}.$(date +%Y%m%d)
 fi

if [ -f "${DIRBin}/netwk" ]; then
   sudo cp ${DIRBin}/netwk ${DIRBin}/netwk.$(date +%Y%m%d)
 fi 

if [ -f "${DIRBin}/dmr" ]; then
   sudo cp ${DIRBin}/dmr  ${DIRBin}/dmr.$(date +%Y%m%d)
 fi 

if [ -f "${DIRBin}/d-star" ]; then
   sudo cp ${DIRBin}/d-star ${DIRBin}/d-star.$(date +%Y%m%d)
 fi 

if [ -f "${DIRBin}/nxdn" ]; then
   sudo cp ${DIRBin}/nxdn  ${DIRBin}/nxdn.$(date +%Y%m%d)
 fi 

if [ -f "${DIRBin}/p25" ]; then
   sudo cp ${DIRBin}/p25 ${DIRBin}/p25.$(date +%Y%m%d)
 fi
 
if [ -f "${DIRBin}/net0" ]; then
   sudo cp ${DIRBin}/net0 ${DIRBin}/net0.$(date +%Y%m%d)
 fi

if [ -f "${DIRBin}/net1" ]; then
   sudo cp ${DIRBin}/net1 ${DIRBin}/net1.$(date +%Y%m%d)
 fi 

if [ -f "${DIRBin}/net2" ]; then
   sudo cp ${DIRBin}/net2 ${DIRBin}/net2.$(date +%Y%m%d)
 fi

if [ -f "${DIRBin}/net3" ]; then
   sudo cp ${DIRBin}/net3 ${DIRBin}/net3.$(date +%Y%m%d)
 fi

if [ -f "${DIRBin}/xlx" ]; then
   sudo cp ${DIRBin}/xlx ${DIRBin}/xlx.$(date +%Y%m%d)
 fi 
sleep 2

echo "* Estruturando..."
echo ""
#sudo rm ${Ap}
sudo rm ${Cp}
sudo rm ${Dp}
sudo rm ${Ep}

if [ -f "$Bp" ]; then
   sudo rm ${Bp}
 fi

if [ -f "$Bpy" ]; then
   sudo rm ${Bpy}
 fi 

if [ -f "$Bpo" ]; then
   sudo rm ${Bpo}
 fi 

if [ -f "${DIRBin}/netwk" ]; then
   sudo rm ${DIRBin}/netwk
 fi

if [ -f "${DIRBin}/dmr" ]; then
   sudo rm ${DIRBin}/dmr
 fi 

if [ -f "${DIRBin}/d-star" ]; then
   sudo rm ${DIRBin}/d-star
 fi 

if [ -f "${DIRBin}/nxdn" ]; then
   sudo rm ${DIRBin}/nxdn
 fi 
 
if [ -f "${DIRBin}/p25" ]; then
   sudo rm ${DIRBin}/p25
 fi
 
if [ -f "${DIRBin}/net0" ]; then
   sudo rm ${DIRBin}/net0
 fi

if [ -f "${DIRBin}/net1" ]; then
   sudo rm ${DIRBin}/net1
 fi

if [ -f "${DIRBin}/net2" ]; then
   sudo rm ${DIRBin}/net2
 fi

if [ -f "${DIRBin}/net3" ]; then
   sudo rm ${DIRBin}/net3
 fi

if [ -f "${DIRBin}/xlx" ]; then
   sudo rm ${DIRBin}/xlx
 fi 
sleep 2

sudo chmod 777 /home/pi-star/c4fm/scw/comandos
sudo chmod 777 /home/pi-star/c4fm/scw/brideg
sleep 1

sudo chmod +x /home/pi-star/c4fm/scw/comandos
sudo chmod +x /home/pi-star/c4fm/scw/brideg
sleep 1

sudo /home/pi-star/c4fm/scw/comandos
sleep 2

sudo /home/pi-star/c4fm/scw/brideg
sleep 2

sudo cp ${DIR}/c4fm-bin-oficial     ${DIRBin}/c4fm
sudo cp ${DIR}/c4fmy-bin-oficial    ${DIRBin}/ysf
sudo cp ${DIR}/c4fmo-bin-oficial    ${DIRBin}/out
sudo cp ${DIR}/MMDVMHost-bin        ${DIRBin}/MMDVMHost
sudo cp ${DIR}/YSFGateway-bin       ${DIRBin}/YSFGateway
sudo cp ${DIR}/pistar-remote-sbin   ${DIRSbin}/pistar-remote
sleep 1

sudo cp ${DIRSCP}/p1                ${DIRBin}/dmr
sudo cp ${DIRSCP}/p2                ${DIRBin}/d-star
sudo cp ${DIRSCP}/p3                ${DIRBin}/nxdn
sudo cp ${DIRSCP}/p4                ${DIRBin}/p25
sleep 1

sudo cp ${DIRSCG}/gr                ${DIRBin}/net0
sudo cp ${DIRSCG}/g1                ${DIRBin}/net1
sudo cp ${DIRSCG}/g2                ${DIRBin}/net2
sudo cp ${DIRSCG}/g3                ${DIRBin}/net3
sudo cp ${DIRSCG}/g4                ${DIRBin}/xlx
sleep 1

sudo chmod 755 ${DIRBin}/dmr
sudo chmod 755 ${DIRBin}/d-star
sudo chmod 755 ${DIRBin}/nxdn
sudo chmod 755 ${DIRBin}/p25
sleep 1

sudo chmod 755 ${DIRBin}/c4fm
sudo chmod 755 ${DIRBin}/ysf
sudo chmod 755 ${DIRBin}/out
sleep 1

sudo chmod 755 ${DIRBin}/net0
sudo chmod 755 ${DIRBin}/net1
sudo chmod 755 ${DIRBin}/net2
sudo chmod 755 ${DIRBin}/net3
sudo chmod 755 ${DIRBin}/xlx
sleep 1

sudo chmod +x  ${DIRBin}/dmr
sudo chmod +x  ${DIRBin}/d-star
sudo chmod +x  ${DIRBin}/nxdn
sudo chmod +x  ${DIRBin}/p25
sleep 1

sudo chmod +x  ${DIRBin}/c4fm
sudo chmod +x  ${DIRBin}/ysf
sudo chmod +x  ${DIRBin}/out
sleep 1

sudo chmod +x  ${DIRBin}/net0
sudo chmod +x  ${DIRBin}/net1
sudo chmod +x  ${DIRBin}/net2
sudo chmod +x  ${DIRBin}/net3
sudo chmod +x  ${DIRBin}/xlx
sleep 1

sudo chmod 755 ${DIRBin}/MMDVMHost
sudo chmod 755 ${DIRBin}/YSFGateway
sudo chmod 755 ${DIREtc}/pistar-remote
sudo chmod 755 ${DIRSbin}/pistar-remote
sleep 1

sudo /usr/local/sbin/HostFilesUpdate.sh      >/dev/null 2>&1 &
sleep 2

echo "* Adicionando dg-id..."
echo ""
sudo cp ${DIR}/Network ${DIRBin}/netwk
sudo chmod 755 ${DIRBin}/netwk
sudo chmod +x  ${DIRBin}/netwk
sudo ${DIRBin}/netwk start
sleep 2

echo "* Ativando servicos..."
echo ""

sudo systemctl start pistar-watchdog.timer   >/dev/null 2>&1 &
sudo systemctl start pistar-watchdog         >/dev/null 2>&1 &
sudo systemctl start mmdvmhost.timer         >/dev/null 2>&1 &
sudo systemctl start mmdvmhost               >/dev/null 2>&1 &
sudo systemctl start ysfgateway.service      >/dev/null 2>&1 &
sudo systemctl start dmr2ysf.service         >/dev/null 2>&1 &
sleep 2
sudo chattr +i ${DIRBin}/YSFGateway
sudo chattr +i ${DIRSbin}/pistar-remote
echo ""
echo -e "\033[01;37m*\033[04;32mFIM\033[00;37m*"
echo ""
cd /home/pi-star
sudo rm -R /home/pi-star/c4fm

;;

2) 
clear
echo -e "\033[01;37m****************************************\033[00;37m"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m*          \033[01;33mRONUALDO - PU4RON\033[00;37m           *"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m*                 \033[01;33mv2.2    \033[00;37m             *"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m****************************************\033[00;37m"
echo ""
echo ""
echo -e "\033[01;37m\033[03;36m* Nova reescrita de TG(s) IPSC2 para uso com C4FM *\033[00;37m"
echo ""
echo -e "\033[01;37m\033[03;36m* As demais redes permanecem inalteradas...*\033[00;37m"
echo ""
echo -e "\033[01;37m\033[03;37m-> Ex: TG 724,   2000724 [7 digitos: 2000+TG]\033[00;37m"
echo ""
echo -e "\033[01;37m\033[03;37m-> Ex: TG 72431, 2072431 [7 digitos: 20+TG]\033[00;37m"
echo ""
echo ""
echo ""

read -p "* Continuar? (S/N) " -n 1 -r
case "$REPLY" in 

  s|S ) echo "" ;;
  n|N ) exit 0 ;;
    * ) exit 0 ;;   
esac
echo ""

DIRgw="/etc/dmrgateway"
DIRpat="/home/pi-star/c4fm/scw/rewritten-patch"

 
if [ -f "$DIRgw" ]; then

    echo ""
    echo "* Iniciando..."
    sleep 1
    sudo chmod 777 ${DIRpat}
    sudo chmod +x  ${DIRpat}
    sudo ${DIRpat}
    sleep 2
    echo ""
    echo -e "\033[01;37m*\033[04;32mFIM\033[00;37m*"
    echo ""
    echo "* -> Configure o DMRGateway e clik em aplicar <- *"
    echo ""

fi

cd /home/pi-star
sudo rm -R /home/pi-star/c4fm
;;

 3)
clear
echo -e "\033[01;37m****************************************\033[00;37m"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m*          \033[01;33mRONUALDO - PU4RON\033[00;37m           *"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m*            \033[01;33mv2.2 BlueDV    \033[00;37m           *"
echo -e "\033[01;37m*                                      *\033[00;37m"
echo -e "\033[01;37m****************************************\033[00;37m"
echo ""
echo ""
read -p "* BlueDV PI-STAR: Continuar? (S/N) " -n 1 -r
case "$REPLY" in 

  s|S ) echo "" ;;
  n|N ) exit 0 ;;
    * ) exit 0 ;;   
esac
echo ""

DIR="/home/pi-star/c4fm"
DIRT="/etc/ser2net.conf"
DIRF="/root/ipv4.fw"
STOP="/usr/local/bin/stop"

echo ""
echo "* Iniciando..."
sleep 2
echo ""
echo "* Parando servicos..."
sudo systemctl stop pistar-watchdog.timer 1> /dev/null 2> /dev/stdout
sudo systemctl stop pistar-watchdog.service 1> /dev/null 2> /dev/stdout
sudo systemctl stop mmdvmhost.timer 1> /dev/null 2> /dev/stdout
sudo systemctl stop mmdvmhost.service 1> /dev/null 2> /dev/stdout
sleep 1
sudo killall MMDVMHost 1> /dev/null 2> /dev/stdout
sudo killall MMDVMHost_NoOLED 1> /dev/null 2> /dev/stdout
sudo killall MMDVMHost_Adafruit 1> /dev/null 2> /dev/stdout
sleep 1
sudo systemctl stop ysfgateway.service 1> /dev/null 2> /dev/stdout
sudo systemctl stop dstarrepeater.service 1> /dev/null 2> /dev/stdout
sudo systemctl stop ircddbgateway.service 1> /dev/null 2> /dev/stdout
sudo systemctl stop dapnetgateway.service 1> /dev/null 2> /dev/stdout
sudo systemctl stop p25gateway.service 1> /dev/null 2> /dev/stdout
sudo systemctl stop p25parrot.service 1> /dev/null 2> /dev/stdout
sudo systemctl stop nxdngateway.service 1> /dev/null 2> /dev/stdout 
sudo systemctl stop nxdnparrot.service 1> /dev/null 2> /dev/stdout
sudo systemctl stop ysfparrot.service 1> /dev/null 2> /dev/stdout 
sudo systemctl stop ysf2dmr.service 1> /dev/null 2> /dev/stdout 
sudo systemctl stop ysf2p25.service 1> /dev/null 2> /dev/stdout 
sudo systemctl stop ysf2nxdn.service 1> /dev/null 2> /dev/stdout 
sudo systemctl stop dmr2ysf.service 1> /dev/null 2> /dev/stdout 
sudo systemctl stop dmr2nxdn.service 1> /dev/null 2> /dev/stdout
sudo systemctl stop dmrgateway.service 1> /dev/null 2> /dev/stdout 
sudo systemctl stop timeserver.service 1> /dev/null 2> /dev/stdout
sleep 1
sudo mount -o remount,ro / 2>&1
sudo mount -o remount,ro /boot 2>&1 
sleep 2
sudo mount -o remount,rw / 2>&1
sudo mount -o remount,rw /boot 2>&1 
sleep 1
if [ -f "$DIRT" ]; then
   sudo cp ${DIRT} ${DIRT}.$(date +%Y%m%d)
 fi

if [ -f "$DIRF" ]; then
   sudo cp ${DIRF} ${DIRF}.$(date +%Y%m%d)
 fi

if [ -f "$STOP" ]; then
   sudo cp ${STOP} ${STOP}.$(date +%Y%m%d)
 fi

if [ -f "$DIRF" ]; then
   sudo rm ${DIRF}
 fi

if [ -f "$STOP" ]; then
   sudo rm ${STOP}
 fi

echo ""
echo "* Estruturando..."
echo ""
sleep 2
echo "* Aguarde... 10%"
echo ""
sudo apt purge ser2net -y 1> /dev/null 2> /dev/stdout
echo "* Aguarde... 50%"
echo "" 
sudo apt-get install ser2net -y  1> /dev/null 2> /dev/stdout
sleep 2

if [ -f "$DIRT" ]; then
   sudo rm ${DIRT}
 fi

if [ -f "$DIR/ipv4.fw" ]; then
   sudo rm $DIR/ipv4.fw
 fi

sudo touch ${DIRT}
sudo chmod 777 ${DIRT}
echo "BANNER:banner:\r\nser2net port \p device \d [\s] (Debian GNU/Linux)\r\n\r\n"  >> ${DIRT}
echo "2000:raw:600:/dev/ttyAMA0:115200 8DATABITS NONE 1STOPBIT"  >> ${DIRT}
sleep 2

sudo touch ${DIR}/ipv4.fw
sudo chmod 777 ${DIR}/ipv4.fw
echo "iptables -A INPUT   -p udp --dport 2000 -j ACCEPT"  >> ${DIR}/ipv4.fw
echo "iptables -A FORWARD -p udp --dport 2000 -j ACCEPT"  >> ${DIR}/ipv4.fw
echo "iptables -A OUTPUT  -p udp --dport 2000 -j ACCEPT"  >> ${DIR}/ipv4.fw
echo "iptables -A INPUT   -p tcp --dport 2000 -j ACCEPT"  >> ${DIR}/ipv4.fw
echo "iptables -A FORWARD -p tcp --dport 2000 -j ACCEPT"  >> ${DIR}/ipv4.fw
echo "iptables -A OUTPUT  -p tcp --dport 2000 -j ACCEPT"  >> ${DIR}/ipv4.fw

if [ -f "$DIR/ipv4.fw" ]; then
   sudo cp ${DIR}/ipv4.fw ${DIRF}
   sudo chmod 777 ${DIRF}
 fi

echo "* Aguarde... 90%"
echo ""
sleep 2

sudo touch ${STOP}
sudo chmod 777 ${STOP}
echo "#!/bin/bash" >> ${STOP}
echo " " >> ${STOP}
echo "sudo systemctl stop pistar-watchdog.timer 1> /dev/null 2> /dev/stdout"   >> ${STOP}
echo "sudo systemctl stop pistar-watchdog.service 1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo systemctl stop mmdvmhost.timer 1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo systemctl stop mmdvmhost.service 1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo systemctl stop ysfgateway.service 1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo systemctl stop dstarrepeater.service 1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo systemctl stop ircddbgateway.service 1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo systemctl stop dapnetgateway.service 1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo systemctl stop p25gateway.service 1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo systemctl stop p25parrot.service 1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo systemctl stop nxdngateway.service 1> /dev/null 2> /dev/stdout" >> ${STOP} 
echo "sudo systemctl stop nxdnparrot.service 1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo systemctl stop ysfparrot.service 1> /dev/null 2> /dev/stdout" >> ${STOP} 
echo "sudo systemctl stop ysf2dmr.service 1> /dev/null 2> /dev/stdout" >> ${STOP} 
echo "sudo systemctl stop ysf2p25.service 1> /dev/null 2> /dev/stdout" >> ${STOP} 
echo "sudo systemctl stop ysf2nxdn.service 1> /dev/null 2> /dev/stdout" >> ${STOP} 
echo "sudo systemctl stop dmr2ysf.service 1> /dev/null 2> /dev/stdout" >> ${STOP} 
echo "sudo systemctl stop dmr2nxdn.service 1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo systemctl stop dmrgateway.service 1> /dev/null 2> /dev/stdout" >> ${STOP} 
echo "sudo systemctl stop timeserver.service 1> /dev/null 2> /dev/stdout" >> ${STOP} 
echo "sleep 1" >> ${STOP}
echo "sudo killall MMDVMHost  1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo killall MMDVMHost_NoOLED  1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "sudo killall MMDVMHost_Adafruit  1> /dev/null 2> /dev/stdout" >> ${STOP}
echo "exit 0" >> ${STOP}
sudo chmod +X ${STOP}
sudo pistar-firewall 1> /dev/null 2> /dev/stdout
sleep 2
sudo systemctl restart ser2net 1> /dev/null 2> /dev/stdout
sleep 2
sudo systemctl restart ser2net 1> /dev/null 2> /dev/stdout
echo "* Concluido. 100%"
echo ""
echo ""
echo -e "\033[01;37m*\033[04;32mFIM\033[00;37m*"
echo ""
cd /home/pi-star
sudo chmod 777 /home/pi-star/c4fm
sudo rm -rf  /home/pi-star/c4fm
sudo mount -o remount,ro / 2>&1 1> /dev/null 2> /dev/stdout
sudo mount -o remount,ro /boot 2>&1 1> /dev/null 2> /dev/stdout
;;

* ) exit 0 ;;   
esac
